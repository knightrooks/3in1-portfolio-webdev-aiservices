{% extends "base.html" %}

{% block title %}AI Chat {% if selected_agent %}- {{ selected_agent.name }}{% endif %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
{% endblock %}

{% block content %}
<div class="chat-interface">
    {% if not selected_agent %}
    <!-- Agent Selection Screen -->
    <div class="agent-selection">
        <div class="container">
            <h1>Choose Your AI Companion</h1>
            <p>Select an agent to start chatting</p>
            
            <div class="agents-grid">
                {% for agent in agents %}
                <div class="agent-selector" data-agent-id="{{ agent.id }}">
                    <div class="agent-avatar">
                        <img src="{{ agent.avatar }}" alt="{{ agent.name }}" onerror="this.src='/static/img/avatar-placeholder.png'">
                    </div>
                    <div class="agent-info">
                        <h3>{{ agent.name }}</h3>
                        <p>{{ agent.description[:100] }}...</p>
                    </div>
                    <a href="{{ url_for('ai_services.chat', agent_id=agent.id) }}" class="btn btn-primary">Chat</a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <!-- Chat Interface -->
    <div class="chat-container" data-agent-id="{{ selected_agent.id }}">
        <div class="chat-header">
            <div class="agent-info">
                <img src="{{ selected_agent.avatar }}" alt="{{ selected_agent.name }}" class="agent-avatar-small">
                <div class="agent-details">
                    <h3>{{ selected_agent.name }}</h3>
                    <span class="agent-status online">Online</span>
                </div>
            </div>
            <div class="chat-actions">
                <button class="btn btn-outline btn-sm" onclick="clearChat()">
                    <i class="fas fa-trash"></i> Clear
                </button>
                <button class="btn btn-outline btn-sm" onclick="exportChat()">
                    <i class="fas fa-download"></i> Export
                </button>
                <a href="{{ url_for('ai_services.agents') }}" class="btn btn-outline btn-sm">
                    <i class="fas fa-users"></i> Switch Agent
                </a>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <div class="agent-avatar">
                    <img src="{{ selected_agent.avatar }}" alt="{{ selected_agent.name }}">
                </div>
                <div class="message-content">
                    <div class="message-text">
                        Welcome! I'm {{ selected_agent.name }}. {{ selected_agent.description }} How can I help you today?
                    </div>
                    <div class="message-time">Just now</div>
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <div class="agent-avatar">
                <img src="{{ selected_agent.avatar }}" alt="{{ selected_agent.name }}">
            </div>
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="input-group">
                <textarea id="messageInput" 
                         placeholder="Type your message to {{ selected_agent.name }}..." 
                         rows="1"
                         maxlength="2000"></textarea>
                <button id="sendButton" class="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="input-footer">
                <span class="character-count">0/2000</span>
                <div class="quick-actions">
                    <button class="quick-btn" onclick="insertQuickMessage('Hello!')">üëã Hello</button>
                    <button class="quick-btn" onclick="insertQuickMessage('How are you?')">‚ùì How are you</button>
                    <button class="quick-btn" onclick="insertQuickMessage('Tell me a joke!')">üòÑ Joke</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">
        <i class="fas fa-wifi"></i> Connected
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
class ChatInterface {
    constructor() {
        this.agentId = '{{ selected_agent.id if selected_agent else "" }}';
        this.sessionId = this.generateSessionId();
        this.socket = null;
        this.isTyping = false;
        
        if (this.agentId) {
            this.init();
        }
    }

    init() {
        this.setupEventListeners();
        this.setupWebSocket();
        this.loadChatHistory();
        this.autoResizeTextarea();
    }

    setupEventListeners() {
        const sendBtn = document.getElementById('sendButton');
        const messageInput = document.getElementById('messageInput');

        sendBtn.addEventListener('click', () => this.sendMessage());
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        messageInput.addEventListener('input', () => {
            this.updateCharacterCount();
            this.handleTyping();
        });
    }

    setupWebSocket() {
        try {
            this.socket = io(`/${this.agentId}`);
            
            this.socket.on('connect', () => {
                this.updateConnectionStatus(true);
                console.log(`Connected to ${this.agentId}`);
            });

            this.socket.on('disconnect', () => {
                this.updateConnectionStatus(false);
                console.log(`Disconnected from ${this.agentId}`);
            });

            this.socket.on('response', (data) => {
                this.hideTypingIndicator();
                this.addMessage(data.message, 'agent');
            });

            this.socket.on('error', (error) => {
                console.error('Socket error:', error);
                this.addMessage('Sorry, I encountered a connection error.', 'agent', true);
            });

        } catch (error) {
            console.log('WebSocket not available, using HTTP requests');
        }
    }

    async sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        
        if (!message) return;

        // Add user message to chat
        this.addMessage(message, 'user');
        messageInput.value = '';
        this.updateCharacterCount();
        
        // Show typing indicator
        this.showTypingIndicator();

        try {
            if (this.socket && this.socket.connected) {
                // Use WebSocket
                this.socket.emit('message', {
                    message: message,
                    session_id: this.sessionId
                });
            } else {
                // Use HTTP request
                const response = await fetch(`/ai/api/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        agent_id: this.agentId,
                        message: message,
                        session_id: this.sessionId
                    })
                });

                const data = await response.json();
                this.hideTypingIndicator();
                
                if (data.success) {
                    this.addMessage(data.response, 'agent');
                } else {
                    this.addMessage('Sorry, I encountered an error processing your message.', 'agent', true);
                }
            }
        } catch (error) {
            console.error('Error sending message:', error);
            this.hideTypingIndicator();
            this.addMessage('Connection error. Please try again.', 'agent', true);
        }
    }

    addMessage(content, sender, isError = false) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message${isError ? ' error-message' : ''}`;
        
        if (sender === 'agent') {
            messageDiv.innerHTML = `
                <div class="agent-avatar">
                    <img src="{{ selected_agent.avatar if selected_agent else '/static/img/avatar-placeholder.png' }}" alt="Agent">
                </div>
                <div class="message-content">
                    <div class="message-text">${this.escapeHtml(content)}</div>
                    <div class="message-time">${this.formatTime(new Date())}</div>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-text">${this.escapeHtml(content)}</div>
                    <div class="message-time">${this.formatTime(new Date())}</div>
                </div>
            `;
        }
        
        messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
        
        // Save to history
        this.saveMessageToHistory(content, sender);
        
        // Animate message
        setTimeout(() => {
            messageDiv.classList.add('animate-in');
        }, 50);
    }

    showTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        indicator.style.display = 'flex';
        this.scrollToBottom();
    }

    hideTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        indicator.style.display = 'none';
    }

    scrollToBottom() {
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    updateCharacterCount() {
        const messageInput = document.getElementById('messageInput');
        const counter = document.querySelector('.character-count');
        const count = messageInput.value.length;
        counter.textContent = `${count}/2000`;
        
        if (count > 1800) {
            counter.style.color = '#dc3545';
        } else if (count > 1500) {
            counter.style.color = '#ffc107';
        } else {
            counter.style.color = '#6c757d';
        }
    }

    autoResizeTextarea() {
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    }

    generateSessionId() {
        const stored = localStorage.getItem(`chat_session_${this.agentId}`);
        if (stored) return stored;
        
        const newSession = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        localStorage.setItem(`chat_session_${this.agentId}`, newSession);
        return newSession;
    }

    saveMessageToHistory(content, sender) {
        const historyKey = `chat_history_${this.agentId}`;
        const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
        
        history.push({
            content,
            sender,
            timestamp: new Date().toISOString()
        });
        
        // Keep only last 100 messages
        if (history.length > 100) {
            history.splice(0, history.length - 100);
        }
        
        localStorage.setItem(historyKey, JSON.stringify(history));
    }

    loadChatHistory() {
        const historyKey = `chat_history_${this.agentId}`;
        const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
        
        // Load last 10 messages
        const recentHistory = history.slice(-10);
        recentHistory.forEach(msg => {
            this.addMessageFromHistory(msg.content, msg.sender, new Date(msg.timestamp));
        });
    }

    addMessageFromHistory(content, sender, timestamp) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message history-message`;
        
        if (sender === 'agent') {
            messageDiv.innerHTML = `
                <div class="agent-avatar">
                    <img src="{{ selected_agent.avatar if selected_agent else '/static/img/avatar-placeholder.png' }}" alt="Agent">
                </div>
                <div class="message-content">
                    <div class="message-text">${this.escapeHtml(content)}</div>
                    <div class="message-time">${this.formatTime(timestamp)}</div>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-text">${this.escapeHtml(content)}</div>
                    <div class="message-time">${this.formatTime(timestamp)}</div>
                </div>
            `;
        }
        
        messagesContainer.insertBefore(messageDiv, messagesContainer.lastElementChild);
    }

    updateConnectionStatus(connected) {
        const status = document.getElementById('connectionStatus');
        if (connected) {
            status.className = 'connection-status connected';
            status.innerHTML = '<i class="fas fa-wifi"></i> Connected';
        } else {
            status.className = 'connection-status disconnected';
            status.innerHTML = '<i class="fas fa-wifi"></i> Disconnected';
        }
    }

    handleTyping() {
        if (this.socket && this.socket.connected && !this.isTyping) {
            this.isTyping = true;
            this.socket.emit('typing_start');
            
            setTimeout(() => {
                this.isTyping = false;
                this.socket.emit('typing_stop');
            }, 1000);
        }
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    formatTime(date) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
}

// Global functions
function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        const messagesContainer = document.getElementById('chatMessages');
        const welcomeMessage = messagesContainer.querySelector('.welcome-message');
        messagesContainer.innerHTML = '';
        messagesContainer.appendChild(welcomeMessage);
        
        // Clear from localStorage
        localStorage.removeItem(`chat_history_${chat.agentId}`);
    }
}

function exportChat() {
    const messages = document.querySelectorAll('.message:not(.welcome-message)');
    let chatText = `Chat with {{ selected_agent.name if selected_agent else 'AI Agent' }}\n`;
    chatText += `Generated on ${new Date().toLocaleString()}\n\n`;
    
    messages.forEach(msg => {
        const sender = msg.classList.contains('user-message') ? 'You' : '{{ selected_agent.name if selected_agent else 'AI' }}';
        const text = msg.querySelector('.message-text').textContent;
        const time = msg.querySelector('.message-time').textContent;
        chatText += `[${time}] ${sender}: ${text}\n`;
    });
    
    const blob = new Blob([chatText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chat-${new Date().toISOString().slice(0, 10)}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

function insertQuickMessage(message) {
    const messageInput = document.getElementById('messageInput');
    messageInput.value = message;
    messageInput.focus();
}

// Initialize chat
let chat;
document.addEventListener('DOMContentLoaded', function() {
    chat = new ChatInterface();
});
</script>
{% endblock %}